---

title: GAN


keywords: fastai
sidebar: home_sidebar

summary: "Basic support for <a href='https://arxiv.org/abs/1406.2661'>Generative Adversarial Networks</a>"
description: "Basic support for <a href='https://arxiv.org/abs/1406.2661'>Generative Adversarial Networks</a>"
nb_path: "nbs/24_vision.gan.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/24_vision.gan.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/opt/conda/lib/python3.9/site-packages/torchvision/io/image.py:11: UserWarning: Failed to load image Python extension: libc10_cuda.so: cannot open shared object file: No such file or directory
  warn(f&#34;Failed to load image Python extension: {e}&#34;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>GAN stands for <a href="https://arxiv.org/pdf/1406.2661.pdf">Generative Adversarial Nets</a> and were invented by Ian Goodfellow. The concept is that we train two models at the same time: a generator and a critic. The generator will try to make new images similar to the ones in a dataset, and the critic will try to classify real images from the ones the generator does. The generator returns images, the critic a single number (usually a probability, 0. for fake images and 1. for real ones).</p>
<p>We train them against each other in the sense that at each step (more or less), we:</p>
<ol>
<li>Freeze the generator and train the critic for one step by:<ul>
<li>getting one batch of true images (let's call that <code>real</code>)</li>
<li>generating one batch of fake images (let's call that <code>fake</code>)</li>
<li>have the critic evaluate each batch and compute a loss function from that; the important part is that it rewards positively the detection of real images and penalizes the fake ones</li>
<li>update the weights of the critic with the gradients of this loss</li>
</ul>
</li>
</ol>
<ol>
<li>Freeze the critic and train the generator for one step by:<ul>
<li>generating one batch of fake images</li>
<li>evaluate the critic on it</li>
<li>return a loss that rewards positively the critic thinking those are real images</li>
<li>update the weights of the generator with the gradients of this loss</li>
</ul>
</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='The fastai library provides support for training GANs through the GANTrainer, but doesn&#8217;t include more than basic models.' %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Wrapping-the-modules">Wrapping the modules<a class="anchor-link" href="#Wrapping-the-modules"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="GANModule" class="doc_header"><code>class</code> <code>GANModule</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L13" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>GANModule</code>(<strong><code>generator</code></strong>=<em><code>None</code></em>, <strong><code>critic</code></strong>=<em><code>None</code></em>, <strong><code>gen_mode</code></strong>=<em><code>False</code></em>) :: <a href="/torch_core.html#Module"><code>Module</code></a></p>
</blockquote>
<p>Wrapper around a <code>generator</code> and a <code>critic</code> to create a GAN.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is just a shell to contain the two models. When called, it will either delegate the input to the <code>generator</code> or the <code>critic</code> depending of the value of <code>gen_mode</code>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="GANModule.switch" class="doc_header"><code>GANModule.switch</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L23" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>GANModule.switch</code>(<strong><code>gen_mode</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Put the module in generator mode if <code>gen_mode</code>, in critic mode otherwise.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>By default (leaving <code>gen_mode</code> to <code>None</code>), this will put the module in the other mode (critic mode if it was in generator mode and vice versa).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="basic_critic" class="doc_header"><code>basic_critic</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L28" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>basic_critic</code>(<strong><code>in_size</code></strong>, <strong><code>n_channels</code></strong>, <strong><code>n_features</code></strong>=<em><code>64</code></em>, <strong><code>n_extra_layers</code></strong>=<em><code>0</code></em>, <strong><code>norm_type</code></strong>=<em><code>&lt;NormType.Batch: 1&gt;</code></em>, <strong><code>ks</code></strong>=<em><code>3</code></em>, <strong><code>stride</code></strong>=<em><code>1</code></em>, <strong><code>padding</code></strong>=<em><code>None</code></em>, <strong><code>bias</code></strong>=<em><code>None</code></em>, <strong><code>ndim</code></strong>=<em><code>2</code></em>, <strong><code>bn_1st</code></strong>=<em><code>True</code></em>, <strong><code>act_cls</code></strong>=<em><code>ReLU</code></em>, <strong><code>transpose</code></strong>=<em><code>False</code></em>, <strong><code>init</code></strong>=<em><code>'auto'</code></em>, <strong><code>xtra</code></strong>=<em><code>None</code></em>, <strong><code>bias_std</code></strong>=<em><code>0.01</code></em>, <strong><code>dilation</code></strong>:<code>Union</code>[<code>int</code>, <code>Tuple</code>[<code>int</code>, <code>int</code>]]=<em><code>1</code></em>, <strong><code>groups</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>padding_mode</code></strong>:<code>str</code>=<em><code>'zeros'</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>dtype</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>A basic critic for images <code>n_channels</code> x <code>in_size</code> x <code>in_size</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="AddChannels" class="doc_header"><code>class</code> <code>AddChannels</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L42" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>AddChannels</code>(<strong><code>n_dim</code></strong>) :: <a href="/torch_core.html#Module"><code>Module</code></a></p>
</blockquote>
<p>Add <code>n_dim</code> channels at the end of the input.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="basic_generator" class="doc_header"><code>basic_generator</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L48" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>basic_generator</code>(<strong><code>out_size</code></strong>, <strong><code>n_channels</code></strong>, <strong><code>in_sz</code></strong>=<em><code>100</code></em>, <strong><code>n_features</code></strong>=<em><code>64</code></em>, <strong><code>n_extra_layers</code></strong>=<em><code>0</code></em>, <strong><code>ks</code></strong>=<em><code>3</code></em>, <strong><code>stride</code></strong>=<em><code>1</code></em>, <strong><code>padding</code></strong>=<em><code>None</code></em>, <strong><code>bias</code></strong>=<em><code>None</code></em>, <strong><code>ndim</code></strong>=<em><code>2</code></em>, <strong><code>norm_type</code></strong>=<em><code>&lt;NormType.Batch: 1&gt;</code></em>, <strong><code>bn_1st</code></strong>=<em><code>True</code></em>, <strong><code>act_cls</code></strong>=<em><code>ReLU</code></em>, <strong><code>transpose</code></strong>=<em><code>False</code></em>, <strong><code>init</code></strong>=<em><code>'auto'</code></em>, <strong><code>xtra</code></strong>=<em><code>None</code></em>, <strong><code>bias_std</code></strong>=<em><code>0.01</code></em>, <strong><code>dilation</code></strong>:<code>Union</code>[<code>int</code>, <code>Tuple</code>[<code>int</code>, <code>int</code>]]=<em><code>1</code></em>, <strong><code>groups</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>padding_mode</code></strong>:<code>str</code>=<em><code>'zeros'</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>dtype</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>A basic generator from <code>in_sz</code> to images <code>n_channels</code> x <code>out_size</code> x <code>out_size</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">critic</span> <span class="o">=</span> <span class="n">basic_critic</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">generator</span> <span class="o">=</span> <span class="n">basic_generator</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">tst</span> <span class="o">=</span> <span class="n">GANModule</span><span class="p">(</span><span class="n">critic</span><span class="o">=</span><span class="n">critic</span><span class="p">,</span> <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">)</span>
<span class="n">real</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="n">real_p</span> <span class="o">=</span> <span class="n">tst</span><span class="p">(</span><span class="n">real</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">real_p</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">tst</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span> <span class="c1">#tst is now in generator mode</span>
<span class="n">noise</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">fake</span> <span class="o">=</span> <span class="n">tst</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fake</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">real</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

<span class="n">tst</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span> <span class="c1">#tst is back in critic mode</span>
<span class="n">fake_p</span> <span class="o">=</span> <span class="n">tst</span><span class="p">(</span><span class="n">fake</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fake_p</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DenseResBlock" class="doc_header"><code>DenseResBlock</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L70" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DenseResBlock</code>(<strong><code>nf</code></strong>, <strong><code>norm_type</code></strong>=<em><code>&lt;NormType.Batch: 1&gt;</code></em>, <strong><code>ks</code></strong>=<em><code>3</code></em>, <strong><code>stride</code></strong>=<em><code>1</code></em>, <strong><code>padding</code></strong>=<em><code>None</code></em>, <strong><code>bias</code></strong>=<em><code>None</code></em>, <strong><code>ndim</code></strong>=<em><code>2</code></em>, <strong><code>bn_1st</code></strong>=<em><code>True</code></em>, <strong><code>act_cls</code></strong>=<em><code>ReLU</code></em>, <strong><code>transpose</code></strong>=<em><code>False</code></em>, <strong><code>init</code></strong>=<em><code>'auto'</code></em>, <strong><code>xtra</code></strong>=<em><code>None</code></em>, <strong><code>bias_std</code></strong>=<em><code>0.01</code></em>, <strong><code>dilation</code></strong>:<code>Union</code>[<code>int</code>, <code>Tuple</code>[<code>int</code>, <code>int</code>]]=<em><code>1</code></em>, <strong><code>groups</code></strong>:<code>int</code>=<em><code>1</code></em>, <strong><code>padding_mode</code></strong>:<code>str</code>=<em><code>'zeros'</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>dtype</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Resnet block of <code>nf</code> features. <code>conv_kwargs</code> are passed to <code>conv_layer</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gan_critic" class="doc_header"><code>gan_critic</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L78" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gan_critic</code>(<strong><code>n_channels</code></strong>=<em><code>3</code></em>, <strong><code>nf</code></strong>=<em><code>128</code></em>, <strong><code>n_blocks</code></strong>=<em><code>3</code></em>, <strong><code>p</code></strong>=<em><code>0.15</code></em>)</p>
</blockquote>
<p>Critic to train a <code>GAN</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="GANLoss" class="doc_header"><code>class</code> <code>GANLoss</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L96" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>GANLoss</code>(<strong><code>gen_loss_func</code></strong>, <strong><code>crit_loss_func</code></strong>, <strong><code>gan_model</code></strong>) :: <a href="/vision.gan.html#GANModule"><code>GANModule</code></a></p>
</blockquote>
<p>Wrapper around <code>crit_loss_func</code> and <code>gen_loss_func</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In generator mode, this loss function expects the <code>output</code> of the generator and some <code>target</code> (a batch of real images). It will evaluate if the generator successfully fooled the critic using <code>gen_loss_func</code>. This loss function has the following signature</p>

<pre><code>def gen_loss_func(fake_pred, output, target):</code></pre>
<p>to be able to combine the output of the critic on <code>output</code> (which the first argument <code>fake_pred</code>) with <code>output</code> and <code>target</code> (if you want to mix the GAN loss with other losses for instance).</p>
<p>In critic mode, this loss function expects the <code>real_pred</code> given by the critic and some <code>input</code> (the noise fed to the generator). It will evaluate the critic using <code>crit_loss_func</code>. This loss function has the following signature</p>

<pre><code>def crit_loss_func(real_pred, fake_pred):</code></pre>
<p>where <code>real_pred</code> is the output of the critic on a batch of real images and <code>fake_pred</code> is generated from the noise using the generator.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="AdaptiveLoss" class="doc_header"><code>class</code> <code>AdaptiveLoss</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L116" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>AdaptiveLoss</code>(<strong><code>crit</code></strong>) :: <a href="/torch_core.html#Module"><code>Module</code></a></p>
</blockquote>
<p>Expand the <code>target</code> to match the <code>output</code> size before applying <code>crit</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="accuracy_thresh_expand" class="doc_header"><code>accuracy_thresh_expand</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L123" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>accuracy_thresh_expand</code>(<strong><code>y_pred</code></strong>, <strong><code>y_true</code></strong>, <strong><code>thresh</code></strong>=<em><code>0.5</code></em>, <strong><code>sigmoid</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Compute accuracy after expanding <code>y_true</code> to the size of <code>y_pred</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Callbacks-for-GAN-training">Callbacks for GAN training<a class="anchor-link" href="#Callbacks-for-GAN-training"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="set_freeze_model" class="doc_header"><code>set_freeze_model</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L129" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>set_freeze_model</code>(<strong><code>m</code></strong>, <strong><code>rg</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="GANTrainer" class="doc_header"><code>class</code> <code>GANTrainer</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L133" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>GANTrainer</code>(<strong><code>switch_eval</code></strong>=<em><code>False</code></em>, <strong><code>clip</code></strong>=<em><code>None</code></em>, <strong><code>beta</code></strong>=<em><code>0.98</code></em>, <strong><code>gen_first</code></strong>=<em><code>False</code></em>, <strong><code>show_img</code></strong>=<em><code>True</code></em>) :: <a href="/callback.core.html#Callback"><code>Callback</code></a></p>
</blockquote>
<p>Handles GAN Training.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include warning.html content='The GANTrainer is useless on its own, you need to complete it with one of the following switchers' %}</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="FixedGANSwitcher" class="doc_header"><code>class</code> <code>FixedGANSwitcher</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L207" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>FixedGANSwitcher</code>(<strong><code>n_crit</code></strong>=<em><code>1</code></em>, <strong><code>n_gen</code></strong>=<em><code>1</code></em>) :: <a href="/callback.core.html#Callback"><code>Callback</code></a></p>
</blockquote>
<p>Switcher to do <code>n_crit</code> iterations of the critic then <code>n_gen</code> iterations of the generator.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="AdaptiveGANSwitcher" class="doc_header"><code>class</code> <code>AdaptiveGANSwitcher</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L228" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>AdaptiveGANSwitcher</code>(<strong><code>gen_thresh</code></strong>=<em><code>None</code></em>, <strong><code>critic_thresh</code></strong>=<em><code>None</code></em>) :: <a href="/callback.core.html#Callback"><code>Callback</code></a></p>
</blockquote>
<p>Switcher that goes back to generator/critic when the loss goes below <code>gen_thresh</code>/<code>crit_thresh</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="GANDiscriminativeLR" class="doc_header"><code>class</code> <code>GANDiscriminativeLR</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L243" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>GANDiscriminativeLR</code>(<strong><code>mult_lr</code></strong>=<em><code>5.0</code></em>) :: <a href="/callback.core.html#Callback"><code>Callback</code></a></p>
</blockquote>
<p><a href="/callback.core.html#Callback"><code>Callback</code></a> that handles multiplying the learning rate by <code>mult_lr</code> for the critic.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="GAN-data">GAN data<a class="anchor-link" href="#GAN-data"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="InvisibleTensor" class="doc_header"><code>class</code> <code>InvisibleTensor</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L258" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>InvisibleTensor</code>(<strong><code>x</code></strong>, <strong>**<code>kwargs</code></strong>) :: <a href="/torch_core.html#TensorBase"><code>TensorBase</code></a></p>
</blockquote>
<p>A <code>Tensor</code> which support subclass pickling, and maintains metadata when casting or after methods</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="generate_noise" class="doc_header"><code>generate_noise</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L262" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>generate_noise</code>(<strong><code>fn</code></strong>, <strong><code>size</code></strong>=<em><code>100</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">bs</span> <span class="o">=</span> <span class="mi">128</span>
<span class="n">size</span> <span class="o">=</span> <span class="mi">64</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dblock</span> <span class="o">=</span> <span class="n">DataBlock</span><span class="p">(</span><span class="n">blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">TransformBlock</span><span class="p">,</span> <span class="n">ImageBlock</span><span class="p">),</span>
                   <span class="n">get_x</span> <span class="o">=</span> <span class="n">generate_noise</span><span class="p">,</span>
                   <span class="n">get_items</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">,</span>
                   <span class="n">splitter</span> <span class="o">=</span> <span class="n">IndexSplitter</span><span class="p">([]),</span>
                   <span class="n">item_tfms</span><span class="o">=</span><span class="n">Resize</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">ResizeMethod</span><span class="o">.</span><span class="n">Crop</span><span class="p">),</span> 
                   <span class="n">batch_tfms</span> <span class="o">=</span> <span class="n">Normalize</span><span class="o">.</span><span class="n">from_stats</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]),</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">LSUN_BEDROOMS</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">dblock</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="GAN-Learner">GAN Learner<a class="anchor-link" href="#GAN-Learner"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="gan_loss_from_func" class="doc_header"><code>gan_loss_from_func</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L279" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>gan_loss_from_func</code>(<strong><code>loss_gen</code></strong>, <strong><code>loss_crit</code></strong>, <strong><code>weights_gen</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Define loss functions for a GAN from <code>loss_gen</code> and <code>loss_crit</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="GANLearner" class="doc_header"><code>class</code> <code>GANLearner</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/gan.py#L298" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>GANLearner</code>(<strong><code>dls</code></strong>, <strong><code>generator</code></strong>, <strong><code>critic</code></strong>, <strong><code>gen_loss_func</code></strong>, <strong><code>crit_loss_func</code></strong>, <strong><code>switcher</code></strong>=<em><code>None</code></em>, <strong><code>gen_first</code></strong>=<em><code>False</code></em>, <strong><code>switch_eval</code></strong>=<em><code>True</code></em>, <strong><code>show_img</code></strong>=<em><code>True</code></em>, <strong><code>clip</code></strong>=<em><code>None</code></em>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>None</code></em>, <strong><code>loss_func</code></strong>=<em><code>None</code></em>, <strong><code>opt_func</code></strong>=<em><code>Adam</code></em>, <strong><code>lr</code></strong>=<em><code>0.001</code></em>, <strong><code>splitter</code></strong>=<em><code>trainable_params</code></em>, <strong><code>path</code></strong>=<em><code>None</code></em>, <strong><code>model_dir</code></strong>=<em><code>'models'</code></em>, <strong><code>wd</code></strong>=<em><code>None</code></em>, <strong><code>wd_bn_bias</code></strong>=<em><code>False</code></em>, <strong><code>train_bn</code></strong>=<em><code>True</code></em>, <strong><code>moms</code></strong>=<em><code>(0.95, 0.85, 0.95)</code></em>) :: <a href="/learner.html#Learner"><code>Learner</code></a></p>
</blockquote>
<p>A <a href="/learner.html#Learner"><code>Learner</code></a> suitable for GANs.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.callback.all</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">generator</span> <span class="o">=</span> <span class="n">basic_generator</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_extra_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">critic</span>    <span class="o">=</span> <span class="n">basic_critic</span>   <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">n_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_extra_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">act_cls</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">,</span> <span class="n">negative_slope</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">GANLearner</span><span class="o">.</span><span class="n">wgan</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="n">critic</span><span class="p">,</span> <span class="n">opt_func</span> <span class="o">=</span> <span class="n">RMSProp</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">train_metrics</span><span class="o">=</span><span class="kc">True</span>
<span class="n">learn</span><span class="o">.</span><span class="n">recorder</span><span class="o">.</span><span class="n">valid_metrics</span><span class="o">=</span><span class="kc">False</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">2e-4</span><span class="p">,</span> <span class="n">wd</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">show_results</span><span class="p">(</span><span class="n">max_n</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ds_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

